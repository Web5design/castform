(function(window,document){function clone(e){if("object"!=typeof e||null===e)return e;var t={};for(var a in e)has(e,a)&&(t[a]=clone(e[a]));return t}function isArray(e){return"[object Array]"===Object.prototype.toString.call(e)}function has(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function seq(e,t){function a(){var r=e.shift();r?r(function(e,r){return e?(a(),void 0):t(e,r)}):t(!0)}a()}function throttle(e,t){var a;return function(r,i,n){clearTimeout(a),a=setTimeout(function(){e(r,i,n)},t)}}function delay(e){var t;return function(a,r,i,n){clearTimeout(t),a?t=setTimeout(function(){e(r,i,n)},a):e(r,i,n)}}function extend(e,t){for(var a in t)if(has(t,a)){var r=typeof e[a];"undefined"===r?e[a]=t[a]:"object"===r&&extend(e[a],t[a])}}function load(e,t){if(t.tooltip!==!1){var a=e.position(),r=e.outerWidth(),i=$("<span>").css({position:"absolute",left:a.left+r+10+"px",top:a.top+"px",fontSize:"10px",color:"white",backgroundColor:"black",padding:"5px 8px 4px 8px",textAlign:"center",borderRadius:"3px",boxShadow:"0 0 5px black",display:"none","float":"right","z-index":1e4,"white-space":"nowrap"}).addClass("castform-tooltip").insertAfter(e);t.tooltip=delay(function(e){e?(i.text(e),i.css("display","block")):i.css("display","none")})}}function check(e,t,a,r){r&&t.tooltip()}function pass(e,t,a,r,i){if(!a||e.val()){var n=t.tooltip;r?n&&n():n&&n(i.tooltipDelay,i.msg)}}function createRegexpValidator(e){return function(t){return e.test(t)}}function createSeqFn(e,t){return e.async?function(a){e.fn(t,function(t,r){var i=clone(e);i.msg=r||i.msg,a(t,i)})}:function(a){a(e.fn(t),e)}}function bindValidation(e,t,a,r,i){var n=r.$field;n.addClass("castform-field"),extend(r,i),isArray(r.validate)||(r.validate=[r.validate]);for(var o=0,s=r.validate.length;s>o;o++){var c=r.validate[o];(c instanceof RegExp||"function"==typeof c)&&(c=r.validate[o]={fn:c}),c.fn.length>1&&(c.fn=throttle(c.fn,c.delay||500),c.async=!0),c.fn instanceof RegExp&&(c.fn=createRegexpValidator(c.fn)),c.msg||(c.msg="Validation failed")}var f=createSuccess(t,n,r),l=createFail(t,n,r),u=createCheckFieldValue(e,n,a,r,f,l);if(n.on("keypress input paste",u),r.storage.session){var d=storage.get(e,a);!d||!r.storage.force&&n.val()||n.val(d)}if(r.cache&&r.storage.cache)for(r.storage.keys=storage.get(e,a+"::keys",[]),o=0,s=r.storage.keys.length;s>o;o++){var v=r.storage.keys[o],m=a+"::result::"+v;r.cache[v]=storage.get(e,m)}r.load&&r.load(n,r),u(null,!0)}function createSuccess(e,t,a){return function(r){a.validating=!1,a.err=!1,t.removeClass("castform-fail"),t.addClass("castform-success"),a.pass(t,a,r,!0);for(var i in a.fields)if(has(a.fields,i)){var n=a.fields[i];if(n.required&&(!n.$field.val()||n.validating||n.err))return}e.attr("disabled",!1)}}function createFail(e,t,a){return function(r,i){a.err=!0,t.removeClass("castform-success"),t.addClass("castform-fail"),a.pass(t,a,r,!1,i),e.attr("disabled",!0)}}function createCheckFieldValue(e,t,a,r,i,n){var o,s=r.validate,c=createValidationFinished(e,a,r,i,n);return function(f,l){var u=t.val();if(u!==o){if(o=u,r.cache){var d=r.cache[u];if(d)return c(u,!1,l,d[0],{msg:d[1]}),void 0}if(r.storage.session&&!l&&storage.set(e,a,u),!u)return r.required?n(l,{msg:"This field is required"}):i(l),void 0;for(var v=!1,m=[],p=0,g=s.length;g>p;p++){var h=s[p];m[p]=createSeqFn(h,u),h.async&&(v=!0)}r.validating=!0,r.check&&r.check(t,r,l,v),seq(m,function(e,t){c(u,v,l,e,t)})}}}function createValidationFinished(e,t,a,r,i){var n=a.$field;return function(o,s,c,f,l){if(a.cache){var u=[f,l?l.msg:null];a.cache[o]=u,a.storage.cache&&(a.storage.keys.push(o),storage.set(e,t+"::keys",a.storage.keys),storage.set(e,t+"::result::"+o,u))}s&&o!==n.val()||(f?r(!1):i(c,l))}}var NAMESPACE="castform::",storage={set:function(e,t,a){localStorage&&(t=NAMESPACE+e+"::"+t,JSON&&JSON.stringify&&(a=JSON.stringify(a)),localStorage.setItem(t,a))},get:function(e,t,a){if(localStorage){t=NAMESPACE+e+"::"+t;var r=localStorage.getItem(t);return r?JSON&&JSON.parse?JSON.parse(r):r:a}return a}},castform=window.castform={};castform.remoteCall=function(e,t,a,r){var i=JSON.stringify({id:t,values:a});$.ajax({type:"POST",url:"/castform/"+e,data:i,success:function(e){r(e.success,e.msg)},error:function(e,t){r(!1,t)},contentType:"application/json",dataType:"json"})},castform.async=function(e){return function(t,a){castform.remoteCall("async",e,t,a)}},$(function(){var e={cache:{},validate:[],required:!1,delay:!1,storage:{session:!1,force:!1,cache:!1},load:load,check:check,pass:pass,submit:{client:{}},icon:!0,borderColor:{success:"green",fail:"red"}},t=castform.options;extend(t,e);for(var a in t.forms)has(t.forms,a)&&(extend(t.forms[a],t),t.forms[a].$form=castform.validateForm(a,t.forms[a]))}),castform.validateForm=function(e,t){var a="#form-"+e,r=$(a);if(r.length){var i=$(a+' input[type="submit"]');for(var n in t.fields)if(has(t.fields,n)){var o=t.fields[n];if(o.$field=r.find('[name="'+n+'"]'),!o.$field.length)throw Error("Form field `"+n+"` not found");bindValidation(e,i,n,o,t)}return r.submit(function(a){function n(a,r){a&&t.submit.server?castform.remoteCall("submit",e,s,o):o(a,r)}function o(e,a){r.removeClass("castform-submit"),e||i.attr("disabled",!1),t.submit.client.pass&&t.submit.client.pass(i,t,c,e,a)}i.attr("disabled",!0),r.addClass("castform-submit"),a.preventDefault();var s={},c={};for(var f in t.fields)if(has(t.fields,f)){var l=t.fields[f],u=l.$field,d=u.is(":checkbox")?u.is(":checked"):u.val();s[f]=d,c[f]=l.sanitize?l.sanitize(d):d}t.submit.client.before&&t.submit.client.before(i,t,c),t.submit.client.validate?t.submit.client.validate(i,t,c,n):n(!0)}),r}},castform.options={};})(window,document);